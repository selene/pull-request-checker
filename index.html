<html>
<head>
  <title>PR Queue Checker</title>
  <script src="jquery-1.11.2.min.js"></script>
  <style>
    form div {
      margin: 5px;
    }
    label {
      display: inline-block;
      width: 130px;
    }
    input[type=submit] {
      padding: 5px 15px;
      cursor:pointer;
      border-radius: 5px;
      width: 292px;
    }
    input[type=submit]#refresh {
      font-size: 18px;
    }
    #credentials {
      margin: 0;
      padding: 0;
    }
    #note {
      top: 5px;
      right: 5px;
      position: absolute;
    }
  </style>
</head>
<body>
  <h1>PR Queue Checker</h1>
  <form id="login">
    <div id="credentials">
      <div><label for="organization">Organization:</label> <input type="text" id="organization" name="organization" value="ThinkNear" /></div>
      <div><label for="username">Github Username:</label> <input type="text" id="username" name="username" /></div>
      <div><label for="password">Password:</label> <input type="password" id="password" name="password" /></div>
    </div>
    <div><input type="submit" id="submit" /><input type="submit" id="refresh" value="Refresh" style="display:none;" /></div>
  </form>
  <div id="results">
  </div>
  <div id="note">
    <div><a href="https://github.com/selenetelenav/pull-request-checker/tree/gh-pages">See the code on GitHub</a></div>
    <div id="update-indicator"></div>
  </div>

<script type="text/javascript">
window.onload = (function(){
  var username;
  var credentials;
  var organization;
  var orgRepos = [];
  var verified = false;
  var loadedOn = new Date();

  $('#update-indicator').hide();
  setInterval(checkForUpdates, 1000*60*60*24);
  function checkForUpdates() {
    $.ajax({
      type: "GET",
      url: "https://api.github.com/repos/selenetelenav/pull-request-checker/commits",
      data: {
        sha: "gh-pages",
        since: loadedOn.toISOString()
      },
      success: function checkCommits(results) {
        if (results.length > 0) {
          var commitString = "<ul>\n";
          for (var r in results) {
            var commit = results[r].commit;
            var commitDate = commit.committer.date.split("T")[0]
            commitString += "<li>" + commitDate + " - " + commit.message.split("\n")[0] + "</li>\n";
          }
          commitString += "</ul>";
          $('#update-indicator').html("<p>Updates available, please reload!</p>\n" + commitString);
          $('#update-indicator').show();
        }
      }
    });
  }

  function setAuthorizationHeader(xhr) {
    $('#results').html("Loading...");
    xhr.setRequestHeader("Authorization", "Basic " + credentials);
  }

  function loginFailed(arguments) {
    $("#results").html("Login failed");
  }

  $('#login').submit(function loginAndScrapeRepos() {
    var userPulls = {};
    var authoredPulls = [];
    var assignedPulls = [];
    var finished = 0;
    username = $('#username').val();
    credentials = btoa($('#username').val() + ":" + $('#password').val());
    organization = $('#organization').val();

    function checkMembership(data, statusText, response) {
      if (response.status == 204) {
        verified = true;
        getRepos();
      } else {
        $("results").html("You don't belong to this organization");
      }
    }

    function getRepos(page) {
      page = page || 1;
      $('#results').html("Loading...");
      $.ajax({
        type: "GET",
        url: "https://api.github.com/orgs/" + organization + "/repos?page=" + page,
        dataType: "json",
        beforeSend: setAuthorizationHeader,
        success: checkForLastPage,
        error: loginFailed
      });
    }

    function checkForLastPage(results, status, response) {
      var link = response.getResponseHeader("Link");
      var links, nextPage;

      orgRepos = orgRepos.concat(results);
      console.log(link);
      if (link && link.indexOf('rel="next"') != -1) {
        links = link.split(",");
        for(var l in links) {
          if (links[l].indexOf('rel="next"') != -1) {
            nextPage = links[l].match(/page=(\d+)/)[1]
            getRepos(nextPage);
          }
        }
      } else {
        scrapeRepos(orgRepos);
      }
    }

    function scrapeRepos(repos) {
      finished = 0;
      repos.forEach(function getRepoPulls(repo) {
        if (repo.open_issues_count == 0) {
          ++finished;
        } else {
          $.ajax({
            type: "GET",
            url: "https://api.github.com/repos/" + organization + "/" + repo.name + "/pulls",
            dataType: 'json',
            beforeSend: setAuthorizationHeader,
            success: function(response) {
              response.forEach(function groupUserPulls(pull) {
                var assignee = pull.assignee ? pull.assignee : {login: "[Unassigned]"};
                var pullData = {
                  url: pull.html_url,
                  name: pull.title,
                  repo: pull.base.repo.name,
                  author: pull.user.login,
                  assignee: assignee
                };
                if (assignee.login.toLowerCase() == username.toLowerCase()) {
                  assignedPulls.push(pullData)
                } else {
                  if (!userPulls[assignee.login]) { userPulls[assignee.login] = []; }
                  userPulls[assignee.login].push(pullData);
                }
                if (pull.user.login.toLowerCase() == username.toLowerCase()) {
                  pullData.assignee = assignee;
                  authoredPulls.push(pullData);
                }
              });

              ++finished;
              if (finished == repos.length) {
                onAllReposFinished(userPulls);
              }
            },
            error: loginFailed
          });
        }
      });
    }

    function onAllReposFinished(userPulls){
      var resultHtml = "";
      var i, u, name, showAssignee, pulls, usernames;
      resultHtml += "<h2>" + username + "</h2>\n"
      resultHtml += "<h3>Your PRs (" + authoredPulls.length +")</h3>\n<ul>\n";
      for (i = 0; i < authoredPulls.length; i++) {
        showAssignee = (authoredPulls[i].assignee.login == "[Unassigned]");
        resultHtml += formatPull(authoredPulls[i], showAssignee);
      }
      resultHtml += "</ul>\n<h3>Your Queue (" + assignedPulls.length + ")</h3>\n"
      if (assignedPulls.length > 0) {
        resultHtml += "<ul>\n";
        for (i = 0; i < assignedPulls.length; i++) {
          resultHtml += formatPull(assignedPulls[i]);
        }
        resultHtml += "</ul>\n";
      } else {
        resultHtml += "<p>Empty queue, good job!</p>\n";
      }

      resultHtml += "<h2>Everyone Else</h2>\n";
      usernames = Object.keys(userPulls).sort();
      for (u in usernames) {
        name = usernames[u];
        pulls = userPulls[name];
        resultHtml += "<div>\n<h3>" + name + " (" + pulls.length + ")</h3>\n<ul>"
        for (i = 0; i < pulls.length; i++) {
          resultHtml += formatPull(pulls[i]);
        }

        resultHtml += "</ul></div>\n"
      }
      $("#results").html(resultHtml);
      $('#credentials').hide();
      $('#submit').hide();
      $('#refresh').show();
    }

    function formatPull(pull, showAssignee) {
      var formatted = "<li><a href='" + pull.url + "'>" + pull.name + "</a> (" + pull.repo + ")";
      if (showAssignee) {
        formatted += " " + pull.assignee.login;
      }
      formatted += "</li>";
      return formatted;
    }

    if (!verified) {
      $.ajax({
        type: "GET",
        url: "https://api.github.com/orgs/" + organization + "/members/" + $('#username').val(),
        dataType: 'json',
        beforeSend: setAuthorizationHeader,
        success: checkMembership,
        error: loginFailed
      });
    } else {
      orgRepos = [];
      getRepos();
    }

    return false;
  });
});

</script>
</body>
</html>
